<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GDS 엔트리 생성기 - 업그레이드 디자인 v3</title>
    <link href="https://cdn.jsdelivr.net/npm/handsontable@14.4/dist/handsontable.full.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <style>
        /* === 업그레이드된 스타일 (v3) === */

        :root {
            /* 색상 변수 정의 */
            --primary-color: #3498db; /* 메인 파란색 */
            --secondary-color: #6c757d; /* 보조 회색 */
            --success-color: #2ecc71; /* 성공 녹색 */
            --danger-color: #e74c3c; /* 오류/경고 빨간색 */
            --warning-color: #f39c12; /* 경고 노란색 */
            --info-color: #3498db; /* 정보 파란색 (메인과 동일) */
            --light-gray-color: #f8f9fa; /* 매우 밝은 회색 (배경) */
            --medium-gray-color: #e9ecef; /* 중간 회색 (테두리, 비활성 배경) */
            --dark-gray-color: #495057; /* 어두운 회색 (텍스트) */
            --text-color: #343a40; /* 기본 텍스트 색상 */
            --white-color: #ffffff;
            --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --border-radius: 8px;
        }

        body {
            font-family: 'Noto Sans KR', sans-serif; /* 웹 폰트 적용 */
            line-height: 1.7; /* 줄 간격 조정 */
            padding: 30px;
            margin: 0 auto;
            background-color: var(--light-gray-color); /* 밝은 회색 배경 */
            color: var(--text-color);
            font-size: 16px; /* 기본 폰트 크기 */
        }

        .container { /* 페이지 전체를 감싸는 컨테이너 (필요시 body 대신 사용) */
            max-width: 1200px; /* 최대 너비 확장 */
            margin: 20px auto;
        }

        h1, h2, h3 { /* h3 추가 */
            color: var(--dark-gray-color);
            margin-bottom: 1em; /* 여백 단위를 em으로 변경 */
            font-weight: 700; /* 제목 굵게 */
        }

        h1 {
            font-size: 2em;
            text-align: center;
            margin-bottom: 1.5em;
            color: var(--primary-color);
        }

        h2 { /* 출력 영역 제목 스타일 */
            font-size: 1.5em;
             /* border-bottom: 2px solid var(--primary-color); */ /* 카드 헤더 사용으로 제거 */
             /* padding-bottom: 0.5em; */
             /* margin-top: 2em; */ /* 카드 간격으로 대체 */
        }

        h3 { /* 카드 내부 부제목 스타일 */
             font-size: 1.3em;
             margin: 0; /* 카드 헤더 내부에서 마진 제거 */
        }

        p {
            margin-bottom: 1em;
            color: #555;
        }

        /* 카드 스타일 (각 섹션을 감싸는 용도) */
        .card {
            background-color: var(--white-color);
            padding: 25px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            margin-bottom: 30px;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--medium-gray-color);
            flex-wrap: wrap; /* 작은 화면에서 버튼 줄바꿈 */
            gap: 10px; /* 헤더 내 요소 간 간격 */
        }
        .card-header h3 {
            margin: 0;
            border: none; /* 카드 헤더 내 제목 구분선 제거 */
        }
        .card-title-icon { /* 아이콘용 클래스 */
            margin-right: 8px;
            color: var(--primary-color);
        }


        /* --- 입력 예시 및 Handsontable 섹션 --- */
        .input-example {
            margin-bottom: 25px;
            font-size: 0.95em;
            padding: 15px;
            background-color: #fdfdfe;
            border: 1px dashed var(--medium-gray-color);
            border-radius: var(--border-radius);
        }
        .input-example strong { color: var(--primary-color); }
        .input-example img {
            max-width: 100%;
            height: auto;
            border: 1px solid var(--medium-gray-color);
            display: block;
            margin-top: 10px;
            border-radius: 4px;
        }

        #passengerGrid {
            width: 100%;
            height: 350px; /* 높이 약간 늘림 */
            overflow: auto;
            margin-bottom: 20px;
            border: 1px solid var(--medium-gray-color); /* 테두리 추가 */
            border-radius: var(--border-radius);
        }
        /* Handsontable 헤더 스타일 개선 */
        .handsontable th {
            background-color: var(--primary-color);
            color: var(--white-color);
            font-weight: 500;
            text-align: center !important; /* 중요도 높여 중앙 정렬 강제 */
            padding: 10px 5px !important; /* 헤더 패딩 조정 */
        }
         .handsontable th .colHeader { /* 헤더 텍스트 줄바꿈 허용 */
             white-space: normal !important;
         }
        .handsontable td { /* 셀 기본 스타일 */
             vertical-align: middle;
             padding: 8px 10px !important; /* 셀 패딩 조정 */
        }
        .htInvalid { background-color: #ffe0e0 !important; /* 오류 셀 배경색 변경 */ }


        /* --- 버튼 스타일 --- */
        .button-group { /* 카드 헤더 안으로 이동하여 불필요할 수 있음 */
            /* margin-bottom: 20px; */
        }
        button {
            padding: 10px 20px;
            border: none; /* 테두리 제거 */
            border-radius: var(--border-radius);
            /* margin-right: 10px; */ /* gap 속성 사용 또는 flex 로 관리 */
            /* margin-bottom: 10px; */
            font-size: 1em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease; /* 부드러운 전환 효과 */
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: inline-flex; /* 아이콘과 텍스트 정렬 위해 */
            align-items: center;
            justify-content: center;
            vertical-align: middle; /* 다른 요소와 세로 정렬 */
            line-height: 1.5; /* 버튼 내 텍스트 줄간격 */
        }
        button i { /* 버튼 내 아이콘 스타일 */
            margin-right: 6px;
        }
        button:hover {
            transform: translateY(-2px); /* 살짝 위로 이동 */
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        button:active {
             transform: translateY(0);
             box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        /* 메인 버튼 */
        #processButton {
            background-color: var(--primary-color);
            color: var(--white-color);
            padding: 12px 25px; /* 메인 버튼 좀 더 크게 */
            font-size: 1.1em;
        }
        #processButton:hover { background-color: #2980b9; }
        #processButton:disabled { background-color: var(--medium-gray-color); color: #999; cursor: not-allowed; transform: none; box-shadow: none;}

        /* 보조 버튼 */
        button.secondary, #confirmDateNo {
            background-color: var(--secondary-color);
            color: var(--white-color);
        }
        button.secondary:hover, #confirmDateNo:hover { background-color: #5a6268; }

        /* 확인 버튼 (Yes) */
        #confirmDateYes {
            background-color: var(--success-color);
            color: var(--white-color);
        }
        #confirmDateYes:hover { background-color: #27ae60; }

        /* 복사 버튼 */
        button.copy-btn {
            padding: 6px 12px;
            font-size: 0.9em;
            margin-left: auto; /* 헤더 오른쪽 끝으로 밀기 (flex 내에서) */
        }
        button.copied {
            background-color: var(--success-color);
            color: var(--white-color);
        }
        button.copy-btn i { margin-right: 5px; } /* 아이콘과 텍스트 간격 */

        /* --- 출발일 입력 섹션 --- */
        #departureDateSection {
            background-color: var(--warning-color); /* 경고 배경색 */
            color: var(--white-color); /* 텍스트 흰색 */
            padding: 20px;
            border: none; /* 테두리 제거 */
            border-radius: var(--border-radius);
            margin-bottom: 25px;
            display: none; /* 기본 숨김 */
            box-shadow: var(--box-shadow);
        }
        #departureDateSection p { color: var(--white-color); margin-bottom: 15px;}
        #departureDateSection label { color: var(--white-color); margin-bottom: 0;} /* 하단 마진 제거 */
        #departureDateSection input[type="text"] {
             border: 1px solid var(--white-color); /* 흰색 테두리 */
             background-color: rgba(255,255,255,0.1); /* 살짝 투명한 배경 */
             color: var(--white-color); /* 입력 텍스트 색상 */
             width: 200px; /* 너비 조정 */
             margin-bottom: 0; /* 하단 마진 제거 */
             margin-left: 10px; /* 레이블과 간격 */
             padding: 8px 12px; /* 패딩 조정 */
             border-radius: var(--border-radius);
        }
        #departureDateSection input[type="text"]::placeholder { /* 플레이스홀더 색상 */
            color: rgba(255,255,255,0.7);
        }
        #departureDateSection button { /* 내부 버튼 스타일 조정 */
             background-color: var(--white-color);
             color: var(--warning-color); /* 버튼 텍스트 색상 */
             box-shadow: none;
             margin-top: 10px; /* 위쪽 여백 */
        }
         #departureDateSection button:hover { background-color: #f8f9fa; }
        #departureDateConfirmMsg { margin-top: 15px; font-weight: 500; }
        #departureDateConfirmButtons { display: none; margin-top: 15px; }
        #dateErrorMsg { color: var(--danger-color); background-color: var(--white-color); padding: 5px 8px; border-radius: 4px; font-size: 0.9em; margin-left: 10px; display: inline-block; }


        /* --- 상태 메시지 --- */
        #statusMessages {
            /* margin-top: 25px; */ /* 카드 패딩으로 대체 */
            padding: 15px;
            background-color: #f0f3f5; /* 약간 다른 배경색 */
            border: 1px solid var(--medium-gray-color); /* 테두리 */
            border-radius: var(--border-radius);
            white-space: pre-wrap;
            font-size: 0.95em;
            color: var(--text-color); /* 기본 텍스트 색상 */
            min-height: 60px; /* 최소 높이 증가 */
            overflow-y: auto;
            max-height: 200px; /* 최대 높이 증가 */
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05); /* 내부 그림자 */
        }
        #statusMessages div { margin-bottom: 5px; padding-left: 1.5em; position: relative; }
        /* 각 상태 아이콘 추가 (예시) */
        #statusMessages div::before {
             font-family: "Font Awesome 6 Free"; /* Font Awesome 사용 */
             font-weight: 900;
             position: absolute;
             left: 0;
             top: 1px;
             width: 1.2em;
             text-align: center;
             opacity: 0.8;
        }
        #statusMessages .error { color: var(--danger-color); font-weight: 500; }
        #statusMessages .error::before { content: "\f071"; } /* Warning icon */
        #statusMessages .info { color: var(--info-color); }
        #statusMessages .info::before { content: "\f05a"; } /* Info icon */
        #statusMessages .process { color: var(--primary-color); font-weight: 500; }
        #statusMessages .process::before { content: "\f110"; animation: fa-spin 2s infinite linear; } /* Spinner icon */
        #statusMessages .success { color: var(--success-color); font-weight: 500; }
        #statusMessages .success::before { content: "\f00c"; } /* Check icon */

        /* --- 출력 영역 --- */
        .output-section {
             /* margin-top: 30px; */ /* 카드 간격으로 대체 */
        }
        .output-section pre {
            background-color: #2c3e50; /* 어두운 배경 */
            color: var(--light-gray-color); /* 밝은 텍스트 */
            padding: 20px;
            border: none; /* 테두리 제거 */
            border-radius: var(--border-radius);
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace; /* 고정폭 폰트 */
            font-size: 0.95em;
            line-height: 1.6;
            box-shadow: var(--box-shadow);
            margin-top: 0; /* 헤더 사용 시 제거 또는 조정 */
        }
        .output-header { /* 출력 영역 헤더 스타일 */
            display: flex;
            justify-content: space-between; /* 제목 <-> 버튼 정렬 */
            align-items: center;
            margin-bottom: 15px; /* 헤더와 pre 태그 사이 간격 */
            padding-bottom: 10px; /* 헤더 하단 패딩 */
            /* border-bottom: 1px solid var(--medium-gray-color); */ /* 필요시 구분선 추가 */
        }
        .output-header h2 { margin: 0; border: none; font-size: 1.3em;} /* 내부 제목 스타일 */

        /* 복사 버튼 스타일 */
        .output-header button.copy-btn {
            background-color: var(--secondary-color); /* 기본 버튼 색상 */
            color: var(--white-color);
            border: none;
            margin-left: 15px; /* 제목과의 최소 간격 */
            flex-shrink: 0; /* 크기 줄어들지 않도록 */
        }
        .output-header button.copy-btn:hover { background-color: #5a6268; } /* 호버 색상 */
        .output-header button.copied { background-color: var(--success-color); border-color: var(--success-color); }


        /* 반응형 고려 */
        @media (max-width: 768px) {
            body { padding: 15px; }
            .container { padding: 0; } /* 컨테이너 패딩 제거 */
            .card { padding: 15px; margin-bottom: 20px; border-radius: 0; box-shadow: none; border-bottom: 1px solid var(--medium-gray-color);} /* 모바일에서 카드 스타일 변경 */
             h1 { font-size: 1.6em; margin-bottom: 1em; }
             h2, .card-header h3 { font-size: 1.2em; } /* 모바일 제목 크기 조정 */

            #departureDateSection { border-radius: 0; }
            #departureDateSection div:first-of-type { flex-direction: column; align-items: flex-start; } /* 출발일 레이블/입력 세로 정렬 */
             #departureDateSection input[type="text"] { width: 100%; margin-left: 0; margin-top: 5px; }

            .output-header { flex-direction: column; align-items: flex-start; gap: 10px; } /* 출력 헤더 세로 정렬 */
            .output-header button.copy-btn { margin-left: 0; align-self: flex-start; } /* 복사 버튼 왼쪽 정렬 */
            button { padding: 10px 15px; font-size: 0.95em;} /* 버튼 크기 약간 줄임 */
            #processButton { width: 100%; } /* 메인 버튼 너비 100% */
        }

    </style>
</head>
<body>

    <div class="container">
        <h1><i class="fas fa-plane-departure card-title-icon"></i>ERP 예약일행 정보 GDS 엔트리 생성기</h1>

        <div class="card">
            <p>ERP에서 예약일행 탭에 정보를 복사하여 아래 표에 붙여넣거나 직접 입력하세요. ERP와 동일한 11개 컬럼 구조이며, 필요한 정보 외에는 무시됩니다.</p>
            <div class="input-example">
                <strong><i class="fas fa-image card-title-icon"></i>입력 예시 (아래 표 형식 참고):</strong>
                <img src="https://www.naeiltour.co.kr/images/web/%EC%98%88%EC%8B%9C.png" alt="입력 예시 이미지">
            </div>
        </div>


        <div class="card">
            <div class="card-header">
                <h3><i class="fas fa-table card-title-icon"></i>탑승객 정보 입력</h3>
                <div class="button-group">
                    <button id="clearAllBtn" class="secondary"><i class="fas fa-trash-alt"></i> 전체 지우기</button>
                </div>
            </div>
            <div id="passengerGrid"></div>
        </div>

        <div id="departureDateSection" class="card"> <p><i class="fas fa-exclamation-triangle"></i> 예약에 유아(INF)가 포함되어 있어 정확한 개월 수 계산이 필요합니다. <strong>여행 출발일을 알려주세요.</strong></p>
             <div style="display: flex; align-items: center; flex-wrap: wrap; gap: 10px;"> <label for="departureDateInput" style="margin: 0;">여행 출발일:</label>
                 <input type="text" id="departureDateInput" placeholder="YYYY-MM-DD" style="margin: 0;">
                 <span id="dateErrorMsg"></span>
             </div>
             <div id="departureDateConfirmMsg"></div>
             <div id="departureDateConfirmButtons" style="margin-top: 15px;">
                 <button id="confirmDateYes"><i class="fas fa-check"></i> 네, 맞습니다</button>
                 <button id="confirmDateNo"><i class="fas fa-times"></i> 아니오 (다시 입력)</button>
             </div>
             <p style="font-size: 0.85em; color: rgba(255,255,255,0.8); margin-top: 15px;">(반드시 'YYYY-MM-DD' 형식으로 입력하거나 붙여넣기 하세요. 예: 2025-12-25)</p>
        </div>

        <div style="text-align: center; margin-bottom: 30px;"> <button id="processButton"><i class="fas fa-cogs"></i> 엔트리 생성</button>
        </div>


        <div class="card">
             <div class="card-header">
                 <h3><i class="fas fa-tasks card-title-icon"></i>처리 상태</h3>
             </div>
             <div id="statusMessages">처리 상태 메시지가 여기에 표시됩니다.</div>
        </div>

        <div class="output-section card">
            <div class="output-header"> <h2><i class="fas fa-file-alt card-title-icon"></i>항공권 NM 형식</h2>
                <button id="copyNmBtn" class="secondary copy-btn"><i class="fas fa-copy"></i> 복사</button> </div>
            <pre id="nmOutput">결과가 여기에 표시됩니다.</pre>
        </div>

        <div class="output-section card">
             <div class="output-header"> <h2><i class="fab fa-avianex card-title-icon"></i>세이버(Sabre) 엔트리 양식</h2>
                 <button id="copySabreBtn" class="secondary copy-btn"><i class="fas fa-copy"></i> 복사</button> </div>
             <pre id="sabreOutput">결과가 여기에 표시됩니다.</pre>
        </div>

    </div> <script src="https://cdn.jsdelivr.net/npm/handsontable@14.4/dist/handsontable.full.min.js"></script>
    <script>
        // === JavaScript 코드 (v3: 플레이스홀더 제거 + 디버깅 로그 포함) ===

        // --- DOM Elements (복사 버튼 추가) ---
        const gridContainer = document.getElementById('passengerGrid');
        const clearAllBtn = document.getElementById('clearAllBtn');
        const departureDateSection = document.getElementById('departureDateSection');
        const departureDateInput = document.getElementById('departureDateInput');
        const dateErrorMsg = document.getElementById('dateErrorMsg');
        const departureDateConfirmMsg = document.getElementById('departureDateConfirmMsg');
        const departureDateConfirmButtons = document.getElementById('departureDateConfirmButtons');
        const confirmDateYes = document.getElementById('confirmDateYes');
        const confirmDateNo = document.getElementById('confirmDateNo');
        const processButton = document.getElementById('processButton');
        const statusMessages = document.getElementById('statusMessages');
        const nmOutput = document.getElementById('nmOutput');
        const sabreOutput = document.getElementById('sabreOutput');
        const copyNmBtn = document.getElementById('copyNmBtn');      // NM 복사 버튼
        const copySabreBtn = document.getElementById('copySabreBtn'); // Sabre 복사 버튼

        // --- Global State (unchanged) ---
        let hot;
        let confirmedDepartureDate = null;
        let passengers = [];
        let hasInfant = false;

        // --- Helper Functions (unchanged) ---
        function logStatus(message, type = 'info') { const entry = document.createElement('div'); entry.textContent = message; const typeClasses = { error: 'error', info: 'info', process: 'process', success: 'success' }; if (typeClasses[type]) { entry.classList.add(typeClasses[type]); } statusMessages.appendChild(entry); statusMessages.scrollTop = statusMessages.scrollHeight; }
        function clearPreviousOutput(clearGrid = false) { statusMessages.innerHTML = ''; nmOutput.textContent = '결과가 여기에 표시됩니다.'; sabreOutput.textContent = '결과가 여기에 표시됩니다.'; passengers = []; hasInfant = false; confirmedDepartureDate = null; departureDateSection.style.display = 'none'; departureDateConfirmMsg.textContent = ''; departureDateConfirmButtons.style.display = 'none'; departureDateInput.value = ''; dateErrorMsg.textContent = ''; processButton.disabled = false; if (clearGrid && hot) { const emptyData = Array.from({ length: 5 }, () => Array(11).fill(null)); hot.loadData(emptyData); logStatus("표의 모든 데이터가 삭제되었습니다.", 'info'); } }
        function parseYYYYMMDD(dateStr) { if (!/^\d{8}$/.test(dateStr)) return null; const year = parseInt(dateStr.substring(0, 4), 10); const month = parseInt(dateStr.substring(4, 6), 10) - 1; const day = parseInt(dateStr.substring(6, 8), 10); const date = new Date(Date.UTC(year, month, day)); if (date.getUTCFullYear() === year && date.getUTCMonth() === month && date.getUTCDate() === day) { return date; } return null; }
        function calculateMonths(dobYYYYMMDD, departureYYYYMMDD) { logStatus(`(처리 과정: 유아 만 개월 수 계산 - 생년월일 ${dobYYYYMMDD}, 출발일 ${departureYYYYMMDD})`, 'process'); const dob = parseYYYYMMDD(dobYYYYMMDD); if (!dob) { logStatus(`오류: 유아 생년월일(${dobYYYYMMDD}) 형식이 잘못되었습니다.`, 'error'); return null; } const depParts = departureYYYYMMDD.split('-'); const depYear = parseInt(depParts[0], 10); const depMonth = parseInt(depParts[1], 10) - 1; const depDay = parseInt(depParts[2], 10); const departureDate = new Date(Date.UTC(depYear, depMonth, depDay)); if (dob >= departureDate) { logStatus(`오류: 유아 생년월일(${dobYYYYMMDD})이 출발일(${departureYYYYMMDD})보다 이후입니다.`, 'error'); return 0; } let months = (departureDate.getUTCFullYear() - dob.getUTCFullYear()) * 12; months -= dob.getUTCMonth(); months += departureDate.getUTCMonth(); if (departureDate.getUTCDate() < dob.getUTCDate()) { months--; } const calculatedMonths = months <= 0 ? 0 : months; logStatus(` -> 계산된 만 개월 수: ${calculatedMonths}`, 'info'); return calculatedMonths; }
        function formatDDMMMYY(dateStr) { const date = parseYYYYMMDD(dateStr); if (!date) return dateStr; const day = String(date.getUTCDate()).padStart(2, '0'); const monthNames = ["JAN", "FEB", "MAR", "APR", "MAY", "JUN", "JUL", "AUG", "SEP", "OCT", "NOV", "DEC"]; const month = monthNames[date.getUTCMonth()]; const year = String(date.getUTCFullYear()).slice(-2); return `${day}${month}${year}`; }
        function isValidDateYYYYMMDD(dateString) { if (!/^\d{4}-\d{2}-\d{2}$/.test(dateString)) { return false; } const date = new Date(dateString + 'T00:00:00Z'); if (isNaN(date.getTime())) { return false; } return date.toISOString().slice(0, 10) === dateString; }

        // --- Handsontable Configuration (플레이스홀더 제거됨) ---
        document.addEventListener('DOMContentLoaded', function() {
            const columnHeaders = [ '한글명', '영문 성*', '영문 이름*', '전화1', '전화2', '전화3', '이메일', '나이*', '생년월일*<br>(YYYYMMDD)', '성별*<br>(M/F)', '탑승객 유형*<br>(ADT/CHD/INF)' ];
            const columns = [ { data: 0 }, { data: 1 }, { data: 2 }, { data: 3, readOnly: true }, { data: 4, readOnly: true }, { data: 5, readOnly: true }, { data: 6, readOnly: true }, { data: 7, type: 'numeric' }, { data: 8 }, { data: 9 }, { data: 10 } ];
            const initialData = Array.from({ length: 5 }, () => Array(11).fill(null));
            hot = new Handsontable(gridContainer, {
                data: initialData,
                rowHeaders: true,
                colHeaders: columnHeaders,
                columns: columns,
                height: 'auto',
                width: '100%',
                licenseKey: 'non-commercial-and-evaluation',
                stretchH: 'all',
                manualRowResize: true,
                manualColumnResize: true,
                contextMenu: ['---------', 'undo', 'redo'],
                allowInsertRow: true,
                allowRemoveRow: false,
                copyPaste: true,
                fillHandle: true,
                minSpareRows: 1,
                beforeChange: (changes, source) => { if (source === 'loadData') return; for (let i = 0; i < changes.length; i++) { const [row, colIndex, oldValue, newValue] = changes[i]; let processedValue = newValue; if (typeof processedValue === 'string') { processedValue = processedValue.trim(); } switch (colIndex) { case 8: if (typeof processedValue === 'string' && /^\d{4}-?\d{2}-?\d{2}$/.test(processedValue)) { const potentialDate = processedValue.replace(/-/g, ''); if (/^\d{8}$/.test(potentialDate)) { processedValue = potentialDate; if (processedValue !== newValue) logStatus(`[Row ${row+1}] 생년월일 형식 변환: ${newValue} -> ${processedValue}`, 'info'); } } break; case 9: if (typeof processedValue === 'string') { const upperVal = processedValue.toUpperCase(); if (upperVal === '남') processedValue = 'M'; else if (upperVal === '여') processedValue = 'F'; if (processedValue !== newValue && ['M','F'].includes(processedValue)) logStatus(`[Row ${row+1}] 성별 변환: ${newValue} -> ${processedValue}`, 'info'); } break; case 10: if (typeof processedValue === 'string') { const upperVal = processedValue.toUpperCase(); if (['성인', 'ADT'].includes(upperVal)) processedValue = 'ADT'; else if (['소아', 'CHD', 'CHILD'].includes(upperVal)) processedValue = 'CHD'; else if (['유아', 'INF', 'INFANT'].includes(upperVal)) processedValue = 'INF'; if (processedValue !== newValue && ['ADT','CHD','INF'].includes(processedValue)) logStatus(`[Row ${row+1}] 탑승객 유형 변환: ${newValue} -> ${processedValue}`, 'info'); } break; } changes[i][3] = processedValue; } },
                afterValidate: (isValid, value, row, prop, source) => { const colIndex = typeof prop === 'number' ? prop : hot.propToCol(prop); if (!isValid) { logStatus(`[Row ${row+1}, Col ${colIndex+1}] 유효하지 않은 값: "${value}"`, 'error'); } },
                cells: function(row, col, prop) {
                    const cellProperties = {};
                    // --- 플레이스홀더 설정 제거됨 ---
                    if (col === 8) { // 생년월일
                        cellProperties.validator = /^\d{8}$/;
                        cellProperties.allowInvalid = false;
                    } else if (col === 9) { // 성별
                        cellProperties.validator = /^(M|F)$/i;
                        cellProperties.allowInvalid = false;
                    } else if (col === 10) { // 탑승객 유형
                        cellProperties.validator = /^(ADT|CHD|INF)$/i;
                        cellProperties.allowInvalid = false;
                    } else if (col === 7) { // 나이
                        cellProperties.validator = /^\d+$/;
                        cellProperties.allowInvalid = false;
                    } else if ([1, 2].includes(col)) { // 영문 성, 영문 이름
                        // No specific properties needed here now
                    } else if (col === 0) { // 한글명 (렌더러는 유지)
                        cellProperties.renderer = function(instance, td, row, col, prop, value, cellProperties) {
                            Handsontable.renderers.TextRenderer.apply(this, arguments);
                            td.style.color = '#777';
                            td.style.fontStyle = 'italic';
                        };
                    } else if ([3, 4, 5, 6].includes(col)) { // 전화, 이메일 (readOnly 및 렌더러는 유지)
                        cellProperties.readOnly = true;
                        cellProperties.renderer = function(instance, td, row, col, prop, value, cellProperties) {
                            Handsontable.renderers.TextRenderer.apply(this, arguments);
                            td.style.color = '#999';
                            td.style.fontStyle = 'italic';
                        };
                    }
                    return cellProperties;
                }
            });

             // --- 나머지 초기화 및 이벤트 리스너 (DOM 로드 후 실행되어야 함) ---

             // Button Event Listeners
             // const processButton = document.getElementById('processButton'); // 이미 위에서 선언됨

             if (clearAllBtn) { // clearAllBtn 요소가 있는지 확인
                clearAllBtn.addEventListener('click', () => { if (hot) { clearPreviousOutput(true); } });
             } else {
                 console.error("Error: Clear All button element not found!");
             }


             if (processButton) { // processButton 요소를 찾았는지 확인
                console.log("Process button element found:", processButton); // <--- 디버깅 로그

                processButton.addEventListener('click', () => {
                    console.log(">>> '엔트리 생성' 버튼 클릭됨!"); // <--- 클릭 시 가장 먼저 실행될 로그

                    try { // 오류 발생 가능성 있는 전체 로직을 try-catch로 감싸기

                        clearPreviousOutput();
                        logStatus("(처리 과정: 엔트리 생성 시작 - 그리드 데이터 읽기)", 'process');
                        console.log("Cleared output, starting data read..."); // <--- 디버깅 로그

                        if (!hot) {
                            logStatus("오류: 그리드가 초기화되지 않았습니다.", 'error');
                            console.error("Error: HOT instance not found!"); // <--- 디버깅 로그
                            return;
                        }
                        const gridData = hot.getData();
                        console.log("Grid data read:", gridData); // <--- 디버깅 로그

                        passengers = [];
                        hasInfant = false;
                        let validationOk = true;
                        logStatus("(처리 과정: 그리드 데이터 유효성 검증 및 변환)", 'process');
                        console.log("Starting validation..."); // <--- 디버깅 로그

                        gridData.forEach((row, index) => {
                            // 빈 행 건너뛰기 조건 강화: 모든 필수 입력칸이 비어있거나 null일 때만 건너뛰기
                            if (!row[1] && !row[2] && (row[7] === null || row[7] === '') && (row[8] === null || row[8] === '') && (row[9] === null || row[9] === '') && (row[10] === null || row[10] === '')) {
                                return;
                            }

                            let rowErrors = [];
                            const lastName = row[1];
                            const firstName = row[2];
                            const age = row[7];
                            const dob = row[8];
                            const gender = row[9];
                            const type = row[10];

                            // 필수 필드 검증 강화
                            if (!lastName || !String(lastName).trim()) rowErrors.push("영문 성(Col 2)");
                            if (!firstName || !String(firstName).trim()) rowErrors.push("영문 이름(Col 3)");
                            if (age === null || age === undefined || String(age).trim() === '' || !/^\d+$/.test(String(age)) || parseInt(age) < 0) rowErrors.push("나이(Col 8)");
                            if (!dob || !/^\d{8}$/.test(String(dob).trim())) rowErrors.push("생년월일(Col 9)");
                            if (!gender || !/^(M|F)$/i.test(String(gender).trim())) rowErrors.push("성별(Col 10)");
                            if (!type || !/^(ADT|CHD|INF)$/i.test(String(type).trim())) rowErrors.push("탑승객 유형(Col 11)");

                            if (rowErrors.length > 0) {
                                logStatus(`[Row ${index + 1}] 필수 정보 오류: ${rowErrors.join(', ')}`, 'error');
                                validationOk = false;
                            } else {
                                const passengerData = {
                                    line: index + 1,
                                    lastName: String(lastName).trim().toUpperCase(),
                                    firstName: String(firstName).trim().toUpperCase(),
                                    age: parseInt(age),
                                    dob: String(dob).trim(),
                                    gender: String(gender).trim().toUpperCase(),
                                    type: String(type).trim().toUpperCase(),
                                    infantMonths: null
                                };
                                passengers.push(passengerData);
                                if (passengerData.type === 'INF') {
                                    hasInfant = true;
                                }
                            }
                        }); // End of gridData.forEach

                        console.log("Validation finished. validationOk:", validationOk, "passengers count:", passengers.length); // <--- 디버깅 로그

                        if (!validationOk) {
                            logStatus("오류: 그리드에 유효하지 않은 데이터가 있습니다. 상태 메시지를 확인하고 수정해주세요.", 'error');
                            // processButton.disabled = false; // 오류 시 버튼 활성화 유지
                            return;
                        }
                        if (passengers.length === 0) {
                            logStatus("처리할 유효한 승객 정보가 그리드에 없습니다.", 'info');
                            // processButton.disabled = false; // 내용 없을 때 버튼 활성화
                            return;
                        }

                        logStatus(` -> 총 ${passengers.length}명의 유효한 승객 정보 처리 시작. 유아 포함 여부: ${hasInfant}`, 'info');
                        console.log(`Processing ${passengers.length} passengers. Has infant: ${hasInfant}`); // <--- 디버깅 로그

                        if (hasInfant) {
                            logStatus("(처리 과정: 출발일 확인 필요 - 사용자 입력 대기)", 'process');
                            console.log("Infant detected, showing departure date section."); // <--- 디버깅 로그
                            departureDateSection.style.display = 'block';
                            processButton.disabled = true; // 유아 있으면 비활성화
                            console.log("Process button disabled for departure date input."); // <--- 디버깅 로그
                        } else {
                            logStatus("(처리 과정: 출발일 확인 불필요 확인, 생성 로직 실행)", 'process');
                            console.log("No infant or date confirmed, calling generateEntries..."); // <--- 디버깅 로그
                            confirmedDepartureDate = null; // 유아 없으면 출발일 초기화
                            generateEntries();
                        }

                    } catch (error) { // try-catch 오류 처리
                         console.error("오류 발생 in processButton click handler:", error);
                         logStatus("처리 중 예기치 않은 오류가 발생했습니다: " + error.message, 'error');
                         processButton.disabled = false; // 오류 발생 시 버튼 활성화
                    }
                });
            } else {
                console.error("Error: Process button element not found!"); // <--- 요소를 못 찾을 경우 오류 로그
            }

            // Departure Date Input & Confirmation Logic
             if(departureDateInput) { // 요소 존재 확인 추가
                departureDateInput.addEventListener('input', () => { /* ... (이전과 동일) ... */ });
             }
             if(confirmDateYes) {
                 confirmDateYes.addEventListener('click', () => { /* ... (이전과 동일) ... */ });
             }
             if(confirmDateNo) {
                 confirmDateNo.addEventListener('click', () => { /* ... (이전과 동일) ... */ });
             }

             // Copy Button Event Listeners
             if(copyNmBtn) {
                 copyNmBtn.addEventListener('click', () => { copyToClipboard(nmOutput.textContent, copyNmBtn, "NM 형식"); });
             }
              if(copySabreBtn) {
                 copySabreBtn.addEventListener('click', () => { copyToClipboard(sabreOutput.textContent, copySabreBtn, "Sabre 형식"); });
             }

        }); // End of DOMContentLoaded

        // --- Entry Generation Function ---
        function generateEntries() {
             console.log(">>> generateEntries function called!"); // <--- 함수 시작 로그
             logStatus("(처리 과정: 준비된 정보 기반 'NM 형식' 및 '세이버 엔트리' 생성)", 'process');
             if (passengers.length === 0) { logStatus("처리할 승객 정보가 없습니다.", 'info'); nmOutput.textContent = ""; sabreOutput.textContent = ""; return; }
             logStatus("(처리 과정: 추출 정보 및 (필요시) 출발일 기반 추가 계산 및 데이터 준비)", 'process');
             if (hasInfant && confirmedDepartureDate) { logStatus("(처리 과정: 'INF' 유형 승객의 만 개월 수 계산 시도)", 'process'); passengers.forEach(p => { if (p.type === 'INF') { p.infantMonths = calculateMonths(p.dob, confirmedDepartureDate); if (p.infantMonths === null) { logStatus(`경고: [Row ${p.line}] 유아(${p.lastName}/${p.firstName})의 개월 수 계산에 실패했습니다.`, 'error'); } } }); }
             else if (hasInfant && !confirmedDepartureDate) { logStatus("경고: 유아(INF)가 포함되어 있으나 출발일이 확인되지 않아, 세이버 엔트리에서 개월 수 정보가 생략됩니다.", 'error'); }

             logStatus("(처리 과정: NM 형식 규칙 적용)", 'process');
             let nmResult = "";
             const adtChdPassengers = passengers.filter(p => p.type === 'ADT' || p.type === 'CHD');
             const infPassengers = passengers.filter(p => p.type === 'INF');
             let currentNmLine = "";
             let passengerCountInLine = 0;

             adtChdPassengers.forEach((p, index) => { const namePart = `${p.lastName}/${p.firstName} `; let codePart = ""; const formattedDobDDMMMYY = formatDDMMMYY(p.dob); if (p.type === 'ADT') { codePart = (p.gender === 'M') ? 'MR' : 'MS'; } else { codePart = (p.gender === 'M') ? `MSTR(CHD/${formattedDobDDMMMYY})` : `MISS(CHD/${formattedDobDDMMMYY})`; } const passengerEntry = namePart + codePart; if (passengerCountInLine === 0) { currentNmLine = "NM1" + passengerEntry; passengerCountInLine = 1; } else { currentNmLine += "1" + passengerEntry; passengerCountInLine++; } if (passengerCountInLine === 9 || index === adtChdPassengers.length - 1) { nmResult += (nmResult ? "\n" : "") + currentNmLine; currentNmLine = ""; passengerCountInLine = 0; } });
             infPassengers.forEach(p => { const namePart = `${p.lastName}/${p.firstName}`; const formattedDobDDMMMYY = formatDDMMMYY(p.dob); const codePart = (p.gender === 'M') ? 'MSTR' : 'MISS'; const infantEntry = `(INF${namePart} ${codePart}/${formattedDobDDMMMYY})`; nmResult += (nmResult ? "\n" : "") + infantEntry; });
             nmOutput.textContent = nmResult || "생성된 NM 형식이 없습니다.";
             logStatus(" -> NM 형식 생성 완료.", 'info');

             logStatus("(처리 과정: 세이버 형식 규칙 적용)", 'process'); // Sabre 오타 수정
             let sabreResult = "";
             let adtChdSabreParts = [];
             passengers.forEach(p => { if (p.type === 'INF') return; const namePart = `${p.lastName}/${p.firstName} `; let codePart = ""; let suffix = ""; if (p.type === 'ADT') { codePart = (p.gender === 'M') ? 'MR' : 'MS'; suffix = ""; } else if (p.type === 'CHD') { codePart = (p.gender === 'M') ? 'MSTR' : 'MISS'; suffix = `*C${p.age}`; } const passengerEntry = namePart + codePart + suffix; adtChdSabreParts.push(passengerEntry); });
             let adtChdSabreLine = "";
             if (adtChdSabreParts.length > 0) { adtChdSabreLine = "-" + adtChdSabreParts[0]; for (let i = 1; i < adtChdSabreParts.length; i++) { adtChdSabreLine += "§-" + adtChdSabreParts[i]; } }
             if (adtChdSabreLine) { sabreResult += adtChdSabreLine; }
             infPassengers.forEach(p => { const namePart = `${p.lastName}/${p.firstName} `; const codePart = (p.gender === 'M') ? 'MSTR' : 'MISS'; let suffix = ""; if (p.infantMonths !== null) { const formattedMonths = String(p.infantMonths).padStart(2, '0'); suffix = `*I${formattedMonths}`; } else { suffix = ''; } /* 개월 수 없으면 빈 문자열 */ const infantEntry = `-I/${namePart}${codePart}${suffix}`; sabreResult += (sabreResult ? "\n§" : "") + infantEntry; }); /* 유아 줄바꿈 문자 변경 */
             sabreOutput.textContent = sabreResult || "생성된 세이버 형식이 없습니다.";
             logStatus(" -> 세이버 엔트리 형식 생성 완료.", 'info');

             logStatus("--- 모든 처리 완료 ---", 'success'); // 성공 로그로 변경
             processButton.disabled = false; // 정상 처리 후 버튼 활성화
             console.log("generateEntries finished successfully. Process button enabled."); // <--- 함수 종료 로그
        } // End of generateEntries function

        // --- Copy Button Function ---
        function copyToClipboard(textToCopy, buttonElement, formatName) {
             if (!textToCopy || textToCopy === '결과가 여기에 표시됩니다.') {
                 logStatus(`${formatName} 내용이 비어 있어 복사할 수 없습니다.`, 'error');
                 return;
             }

             if (navigator.clipboard && navigator.clipboard.writeText) {
                 navigator.clipboard.writeText(textToCopy)
                     .then(() => {
                         // Success feedback
                         const originalText = buttonElement.innerHTML; // Use innerHTML to handle icons
                         buttonElement.innerHTML = '<i class="fas fa-check"></i> 복사됨!';
                         buttonElement.classList.add('copied');
                         logStatus(`${formatName} 내용이 클립보드에 복사되었습니다.`, 'success');

                         // Reset button after a delay
                         setTimeout(() => {
                             buttonElement.innerHTML = originalText;
                             buttonElement.classList.remove('copied');
                         }, 1500); // 1.5 seconds
                     })
                     .catch(err => {
                         // Error feedback
                         logStatus(`오류: ${formatName} 내용을 클립보드에 복사하지 못했습니다. (${err.message})`, 'error');
                         console.error('Clipboard writeText failed:', err);
                     });
             } else {
                 // Fallback or error for unsupported browsers
                 logStatus('오류: 클립보드 API가 지원되지 않는 브라우저입니다.', 'error');
                 // Consider implementing document.execCommand('copy') fallback here if needed
             }
        } // End of copyToClipboard function

    </script>

</body>
</html>
